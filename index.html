<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#F39B5D" />
  <meta name="description" content="Snuggy, der Hauspebble ‚Äì Mach-gut-App. Mini-Schritte, schamfrei, offline-first." />

  <!-- iOS Web-App Feeling -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Snuggy" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- iOS Icons (nicht umbenennen!) -->
  <link rel="apple-touch-icon" sizes="180x180" href="./icon-180_v3.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="./icon-167_v3.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="./icon-152_v3.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="./icon-120_v3.png" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />

  <title>Snuggy ‚Äì Mach-gut-App</title>

  <style>
    :root{
      /* Snuggy Palette (warm + freundlich) */
      --bg1:#FFE7D6;   /* helles apricot */
      --bg2:#F7D9C8;   /* warmes beige */
      --bg3:#EADCF7;   /* sanftes lila */
      --card:#FFF7F1;  /* cremig */
      --card2:#FFF1E7; /* leicht orange */
      --ink:#2A1E1A;   /* dunkelbraun */
      --muted:#6A4A3A; /* braun gedimmt */
      --line:rgba(58,30,20,.18);
      --shadow: 0 10px 24px rgba(60,20,10,.12);

      --orange:#F39B5D;
      --orange2:#F08A3C;
      --purple:#7E57C2;
      --green:#2EAD74;
      --red:#D64A53;

      --r:18px;
      --pad:14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background:
        radial-gradient(1100px 700px at 15% 0%, var(--bg3) 0%, rgba(234,220,247,0) 60%),
        radial-gradient(1100px 700px at 85% 10%, var(--bg1) 0%, rgba(255,231,214,0) 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      padding-bottom: calc(92px + env(safe-area-inset-bottom));
      -webkit-font-smoothing:antialiased;
    }

    header{
      padding:14px 16px 8px;
      max-width:820px;
      margin:0 auto;
    }
    .hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .titleWrap{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    main{
      max-width:820px;
      margin:0 auto;
      padding:8px 16px 16px;
    }

    .card{
      background:rgba(255,247,241,.88);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:var(--pad);
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .card.soft{
      background:rgba(255,241,231,.78);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ display:flex; flex-direction:column; gap:10px; }
    .muted{ color:var(--muted); font-size:12px; line-height:1.25; }
    .sep{ height:1px; background:var(--line); margin:12px 0; }

    .btn{
      border:1px solid rgba(58,30,20,.18);
      background:rgba(255,255,255,.55);
      color:var(--ink);
      padding:14px 14px;
      border-radius:18px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .05s ease;
    }
    .btn:active{ transform:scale(.985); }
    .btn.primary{
      background:linear-gradient(180deg, var(--orange), var(--orange2));
      border-color: rgba(120,50,20,.18);
    }
    .btn.purple{
      background:linear-gradient(180deg, #8D6AE0, var(--purple));
      color:white;
      border-color: rgba(60,20,120,.25);
    }
    .btn.green{
      background:linear-gradient(180deg, #3ED59A, var(--green));
      color:#0c2a1c;
      border-color: rgba(20,80,50,.18);
    }
    .btn.ghost{
      background:rgba(255,255,255,.25);
    }
    .btn.big{
      width:100%;
      padding:18px 16px;
      font-size:16px;
      border-radius:22px;
    }

    .nav{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,247,241,.78);
      border-top:1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .nav .row{
      max-width:820px;
      margin:0 auto;
      gap:10px;
    }
    .nav .btn{ flex:1; padding:12px 10px; border-radius:16px; font-size:13px; }

    /* Start: Vollbild Snuggy */
    .hero{
      overflow:hidden;
      border-radius:24px;
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      background:rgba(255,255,255,.5);
    }
    .hero img{
      width:100%;
      display:block;
      max-height: 56vh;
      object-fit: contain;
      background: linear-gradient(180deg, rgba(255,241,231,.65), rgba(255,231,214,.55));
    }
    .heroBottom{
      padding:14px;
    }

    /* Kategorie Buttons gro√ü */
    .catGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }

    /* Rubriken als gro√üe Buttons, kompakte Hearts-Anzeige */
    .rubricBtn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      width:100%;
      text-align:left;
    }
    .rubricTitle{ font-size:15px; font-weight:950; }
    .rubricStep{ font-size:12px; color:var(--muted); margin-top:4px; font-weight:700; }
    .badge{
      font-size:12px;
      font-weight:950;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.55);
      white-space:nowrap;
    }

    /* kleine Herzen (halb/ voll) */
    .heartsMini{
      display:flex;
      gap:4px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:nowrap;
    }
    .h{
      width:10px;
      height:10px;
      border-radius:3px;
      border:1px solid rgba(58,30,20,.22);
      background:rgba(255,255,255,.35);
    }
    .h.half{
      background: linear-gradient(90deg, rgba(214,74,83,.9) 50%, rgba(255,255,255,.35) 50%);
      border-color: rgba(214,74,83,.5);
    }
    .h.full{
      background: rgba(214,74,83,.95);
      border-color: rgba(214,74,83,.5);
    }

    /* Quest View */
    .questTop{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .avatar{
      width:54px; height:54px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.55);
      flex:0 0 auto;
      object-fit:contain;
      padding:6px;
    }
    .qTitle{ margin:0; font-size:18px; font-weight:1000; }
    .qSub{ margin:4px 0 0; font-size:12px; color:var(--muted); font-weight:800; }

    .scoreRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.55);
      font-size:12px;
      font-weight:950;
    }

    /* Herz Raster (kompakt) */
    .grid{
      display:grid;
      grid-template-columns:repeat(10, minmax(0,1fr));
      gap:6px;
      margin-top:10px;
    }
    .cell{
      aspect-ratio:1/1;
      border-radius:10px;
      border:1px solid rgba(58,30,20,.18);
      background:rgba(255,255,255,.40);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      font-size:12px;
      color:rgba(42,30,26,.55);
    }
    .cell.half{ background: linear-gradient(90deg, rgba(214,74,83,.9) 50%, rgba(255,255,255,.40) 50%); border-color: rgba(214,74,83,.45); color: rgba(42,30,26,.18);}
    .cell.full{ background: rgba(214,74,83,.92); border-color: rgba(214,74,83,.45); color: rgba(42,30,26,.0); }

    dialog{
      border:none;
      border-radius:22px;
      padding:16px;
      max-width:560px;
      width:calc(100% - 24px);
      background: rgba(255,247,241,.97);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
    }
    dialog::backdrop{ background: rgba(0,0,0,.35); }

    .dlgHead{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .dlgHead img{
      width:54px; height:54px; border-radius:18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.6);
      object-fit:contain;
      padding:6px;
    }

    /* very mobile friendly spacing */
    @media (max-width:420px){
      .grid{ grid-template-columns:repeat(8, minmax(0,1fr)); }
      .nav .btn{ font-size:12px; }
    }
  </style>
</head>

<body>
<header>
  <div class="hdr">
    <div class="titleWrap">
      <h1>Snuggy, der Hauspebble</h1>
      <div class="subtitle">Mach-gut-App</div>
    </div>
  </div>
</header>

<main id="app"></main>

<div class="nav">
  <div class="row">
    <button class="btn" onclick="go('start')">Start</button>
    <button class="btn" onclick="go('kats')">Kategorien</button>
    <button class="btn" onclick="go('konto')">Konto</button>
    <button class="btn ghost" onclick="go('settings')">Einstellungen</button>
  </div>
</div>

<!-- Geschenk alle 5 Herzen -->
<dialog id="dlgGift">
  <div class="dlgHead">
    <img src="./snuggy_avatar_v3.png" alt="Snuggy" />
    <div>
      <div style="font-weight:1000;font-size:16px;margin:0">Geschenk üéÅ</div>
      <div class="muted">Alle 5 Herzen. Zufall. Lob + kleine G√∂nnung.</div>
    </div>
  </div>
  <div class="sep"></div>
  <div class="card soft" style="padding:12px">
    <div id="giftText" style="font-weight:1000"></div>
    <div class="muted" style="margin-top:6px">G√∂nn dir das. Ohne Debatte.</div>
  </div>
  <div class="row" style="justify-content:flex-end;margin-top:12px">
    <button class="btn" onclick="closeDlg('dlgGift')">Okay</button>
  </div>
</dialog>

<!-- T√§gliche √úberraschung -->
<dialog id="dlgSurprise">
  <div class="dlgHead">
    <img src="./snuggy_avatar_v3.png" alt="Snuggy" />
    <div>
      <div style="font-weight:1000;font-size:16px;margin:0">T√§gliche √úberraschung ‚ú®</div>
      <div class="muted">Einmal pro Tag. Vor oder nach der Arbeit.</div>
    </div>
  </div>
  <div class="sep"></div>
  <div class="card soft" style="padding:12px">
    <div id="surpriseText" style="font-weight:1000"></div>
  </div>
  <div class="row" style="justify-content:flex-end;margin-top:12px">
    <button class="btn" onclick="closeDlg('dlgSurprise')">Okay</button>
  </div>
</dialog>

<script>
/* =========================================================
   Snuggy Mach-gut-App v3
   - Neues Farbschema
   - Start: Snuggy Vollbild + Jetzt spielen
   - Kategorien -> Rubriken (gro√üe Buttons)
   - Herzsystem: Einheiten (halbe Herzen)
       Mini = 1 Einheit (0.5 Herz)  -> alle 2 Minis = 1 Herz
       Normal = 2 Einheiten (1 Herz)
       Boss = 4 Einheiten (2 Herzen)
   - Geschenk alle 5 Herzen (=10 Einheiten)
   - T√§gliche √úberraschung: 1x/Tag
   ========================================================= */

const KEY = "snuggy_v3_state";

/* Herz-Units */
const U_HALF = 1;         // 0.5 Herz
const U_HEART = 2;        // 1 Herz
const U_BOSS = 4;         // 2 Herzen

const UNITS_PER_GIFT = 10; // 5 Herzen

const DEFAULT = {
  view: "start",
  activeCat: null,
  activeQuestId: null,

  settings: {
    lowMotion: false
  },

  bank: {
    totalUnits: 0,             // in halben Herzen
    bigGoalHearts: 100,        // Boss Ziel: 100 Herzen
    bigGoalText: "Special Day / Therme",
    gifts: [
      "‚ÄûDu machst das gro√üartig, Baby‚Äú ‚Äì G√∂nn dir: Lieblingssnack.",
      "‚ÄûKein Schwanz ist so hart wie das Leben‚Äú ‚Äì Mach dir ein Eis/Drink/Tee.",
      "‚ÄûAy Papi, nie war ich stolzer auf dich‚Äú ‚Äì 15 Minuten guilt-free Spiel.",
      "‚ÄûCrazy MoFo, das hast du hinter dir‚Äú ‚Äì Musik an, Kopfh√∂rer drauf.",
      "‚ÄûSind Sie auch so ein S√º√ümaul?‚Äú ‚Äì Dann g√∂nn dir einen Snack.",
      "‚ÄûLizenz zum Ausrasten‚Äú ‚Äì Zeig Boomer-J√ºrgen oder Dinkel-D√∂rthe, wo der Hammer h√§ngt."
    ],
    giftHistory: []
  },

  surprise: {
    lastDate: null, // "YYYY-MM-DD"
    texts: [
      "Snuggy sagt: ‚ÄûVor der Arbeit: R√ºcken gerade. Du gehst da rein wie ein Champion.‚Äú",
      "Snuggy sagt: ‚ÄûDu bist wach, du bist da ‚Äî das reicht, um zu gewinnen. Los.‚Äú",
      "Snuggy sagt: ‚ÄûHeute ist Trainingstag. Nicht perfekt ‚Äî aber pr√§sent. Stark.‚Äú",
      "Snuggy sagt: ‚ÄûDu hast schon gewonnen, weil du aufgetaucht bist. Jetzt zieh‚Äôs durch.‚Äú",
      "Snuggy sagt: ‚ÄûFeierabend: Du hast geliefert. Punkt. Respekt.‚Äú",
      "Snuggy sagt: ‚ÄûDu bist nicht kaputt ‚Äî du bist im Aufbau. Und du baust gerade.‚Äú",
      "Snuggy sagt: ‚ÄûFahrr√§der bleiben kaputt, Wunden heilen.‚Äú",
      "Snuggy sagt: ‚ÄûHeute war nicht leicht ‚Äî und genau deswegen warst du stark.‚Äú",
      "Snuggy sagt: ‚ÄûWenn der Kopf schreit: egal. Du machst es trotzdem. Das ist Cobra Kai-Mindset.‚Äú",
      "Snuggy sagt: ‚ÄûNach der Arbeit: Helm ab, Schuhe aus. Du hast‚Äôs √ºberlebt UND abgeliefert. Starkes Ding.‚Äú",
      "Snuggy sagt: ‚ÄûDu lebst noch. Ja dann hast du alles verdient, das du haben willst.‚Äú",
      "Snuggy sagt: ‚ÄûIch bin stolz auf dich. Jetzt leg dich trocken weg.‚Äú",
      "Snuggy sagt: ‚ÄûHeute wird nicht perfekt. Heute wird erledigt. Punkt.‚Äú",
      "Snuggy sagt: ‚ÄûDu bist nicht allein. Ich bin hier. Jetzt raus da.‚Äú",
      "Snuggy sagt: ‚ÄûHeute war hart. Du warst h√§rter. Punkt.‚Äú",
      "Snuggy sagt: ‚ÄûDu hast heute nicht aufgegeben. Das ist der ganze Trick.‚Äú",
      "Snuggy sagt: ‚ÄûDu hast gearbeitet, obwohl‚Äôs schwer war. Das ist der ganze Trick.‚Äú",
      "Snuggy sagt: ‚ÄûDu bist nicht faul ‚Äî du bist ersch√∂pft. Und du hast Pausen verdient.‚Äú"
    ]
  },

  cats: [
    { id:"finanzen", name:"Finanzen", color:"primary" },
    { id:"freizeit", name:"Freizeit", color:"purple" },
    { id:"gesundheit", name:"Gesundheit", color:"green" },
    { id:"haushalt", name:"Haushalt", color:"ghost" }
  ],

  /* Rubriken/Quests: jede hat progressUnits und actions (f√ºr Undo) */
  quests: [
    // FINANZEN
    { id:"fin_a", cat:"finanzen", title:"Kontocheck", step:"Banking √∂ffnen ‚Äì ansehen ‚Äì fertig", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"fin_b", cat:"finanzen", title:"Impulskauf gestoppt", step:"Was tolles gesehen ‚Äì Seite geschlossen ‚Äì fertig", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"fin_c", cat:"finanzen", title:"Gekocht statt bestellt", step:"Lebensmittel genutzt", gridHearts: 20, progressUnits: 0, actions:[] },

    // FREIZEIT
    { id:"free_a", cat:"freizeit", title:"Frische Luft", step:"Schuhe an ‚Äì nur kurz raus", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"free_b", cat:"freizeit", title:"Gym", step:"Tasche packen ‚Äì auftauchen ist der Erfolg", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"free_c", cat:"freizeit", title:"Ritual", step:"Regelm√§√üiges Ritual reicht (TV/Podcast)", gridHearts: 20, progressUnits: 20?0:0, actions:[] }, /* trick to keep linter quiet */
    { id:"free_d", cat:"freizeit", title:"Joggen", step:"Schuhe an und fertig", gridHearts: 20, progressUnits: 0, actions:[] },

    // GESUNDHEIT
    { id:"health_a", cat:"gesundheit", title:"Arzttermin gemacht", step:"Anruf gen√ºgt", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"health_b", cat:"gesundheit", title:"Protein", step:"Jedes Gramm z√§hlt", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"health_c", cat:"gesundheit", title:"Fr√ºhst√ºck gehabt", step:"Anti-Hangry Modus", gridHearts: 20, progressUnits: 20?0:0, actions:[] },
    { id:"health_d", cat:"gesundheit", title:"Tag ohne S√º√üigkeit", step:"Entsch√§digung: doppelte Punkte", gridHearts: 20, progressUnits: 0, actions:[], doublePoints:true },

    // HAUSHALT
    { id:"home_a", cat:"haushalt", title:"Sp√ºlmaschine", step:"Ein- oder ausger√§umt", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"home_b", cat:"haushalt", title:"M√ºll rausbringen", step:"Ist auch frische Luft", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"home_c", cat:"haushalt", title:"K√ºchenm√ºll in Abfall", step:"Besser als aufr√§umen", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"home_d", cat:"haushalt", title:"Ruby", step:"Ruby arbeitet, du die Credits", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"home_e", cat:"haushalt", title:"W√§sche/Trockner", step:"Jede Ladung z√§hlt", gridHearts: 20, progressUnits: 0, actions:[] },
    { id:"home_f", cat:"haushalt", title:"Post", step:"Ge√∂ffnet/bearbeitet/abgelegt ‚Äì alles z√§hlt", gridHearts: 20, progressUnits: 0, actions:[] }
  ]
};

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(KEY));
    if(!s) return structuredClone(DEFAULT);

    // Mergen, damit Updates robust bleiben
    const merged = {
      ...structuredClone(DEFAULT),
      ...s,
      settings: { ...structuredClone(DEFAULT.settings), ...(s.settings||{}) },
      bank: { ...structuredClone(DEFAULT.bank), ...(s.bank||{}) },
      surprise: { ...structuredClone(DEFAULT.surprise), ...(s.surprise||{}) },
      cats: (s.cats && s.cats.length) ? s.cats : structuredClone(DEFAULT.cats),
      quests: (s.quests && s.quests.length) ? s.quests : structuredClone(DEFAULT.quests)
    };

    // ensure quest fields exist
    for(const q of merged.quests){
      if(typeof q.progressUnits !== "number") q.progressUnits = 0;
      if(!Array.isArray(q.actions)) q.actions = [];
      if(typeof q.gridHearts !== "number") q.gridHearts = 20;
    }
    return merged;
  }catch(e){
    return structuredClone(DEFAULT);
  }
}

let state = loadState();

function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

function go(view){
  state.view = view;
  if(view !== "quest") state.activeQuestId = null;
  saveState();
  render();
}

function openCat(catId){
  state.activeCat = catId;
  state.view = "cat";
  saveState();
  render();
}

function openQuest(qid){
  state.activeQuestId = qid;
  state.view = "quest";
  saveState();
  render();
}

function closeDlg(id){
  document.getElementById(id).close();
  render();
}

/* Units helpers */
function unitsToHeartsText(units){
  const hearts = units / 2;
  // show .5 if needed
  return Number.isInteger(hearts) ? `${hearts}` : `${hearts.toFixed(1)}`;
}

function totalHearts(){
  return state.bank.totalUnits / 2;
}

/* Gift trigger every 5 hearts */
function maybeGift(prevUnits, newUnits){
  const prevGifts = Math.floor(prevUnits / UNITS_PER_GIFT);
  const newGifts  = Math.floor(newUnits / UNITS_PER_GIFT);
  const diff = newGifts - prevGifts;

  if(diff <= 0) return;

  // Falls du mehrere Schwellen in einem Schritt √ºberspringst:
  for(let i=0; i<diff; i++){
    openGift();
  }
}
function openGift(){
  const arr = state.bank.gifts || [];
  const pick = arr.length ? arr[Math.floor(Math.random()*arr.length)] : "G√∂nn dir was Kleines.";
  document.getElementById("giftText").textContent = pick;

  state.bank.giftHistory = state.bank.giftHistory || [];
  state.bank.giftHistory.push({ t: Date.now(), text: pick });
  saveState();

  document.getElementById("dlgGift").showModal();
}

/* Surprise once per day */
function canUseSurprise(){
  return state.surprise.lastDate !== todayISO();
}

function useSurprise(){
  if(!canUseSurprise()) return;

  const texts = state.surprise.texts || [];
  const pick = texts.length ? texts[Math.floor(Math.random()*texts.length)] : "Snuggy sagt: ‚ÄûDu machst das.‚Äú";
  document.getElementById("surpriseText").textContent = pick;

  state.surprise.lastDate = todayISO();
  saveState();

  document.getElementById("dlgSurprise").showModal();
}

/* Quest actions */
function addAction(qid, units, label){
  const q = state.quests.find(x=>x.id===qid);
  if(!q) return;

  // doublePoints quest
  if(q.doublePoints) units *= 2;

  q.actions.push({ t: Date.now(), u: units, label });
  const prev = state.bank.totalUnits;

  q.progressUnits += units;
  state.bank.totalUnits += units;

  saveState();
  maybeGift(prev, state.bank.totalUnits);
  render();
}

function undoAction(qid){
  const q = state.quests.find(x=>x.id===qid);
  if(!q || !q.actions.length) return;

  const last = q.actions.pop();
  const u = Number(last.u||0);
  q.progressUnits = Math.max(0, q.progressUnits - u);
  state.bank.totalUnits = Math.max(0, state.bank.totalUnits - u);

  saveState();
  render();
}

function resetQuest(qid){
  const q = state.quests.find(x=>x.id===qid);
  if(!q) return;

  // Schamfrei: wir resetten nur Quest-Progress, nicht die Bank.
  q.progressUnits = 0;
  q.actions = [];
  saveState();
  render();
}

/* UI components */
function miniHearts(units, maxHearts=10){
  // show up to maxHearts hearts (each heart = 2 units)
  const maxUnits = maxHearts * 2;
  const shownUnits = Math.min(units, maxUnits);

  let html = `<div class="heartsMini" aria-label="Fortschritt">`;
  for(let i=0;i<maxHearts;i++){
    const slotUnits = shownUnits - i*2;
    const cls = slotUnits >= 2 ? "h full" : slotUnits === 1 ? "h half" : "h";
    html += `<span class="${cls}"></span>`;
  }
  html += `</div>`;
  return html;
}

function questGrid(units, gridHearts){
  // gridHearts hearts = gridHearts * 2 units
  const totalSlots = gridHearts;
  let html = `<div class="grid">`;
  for(let i=0;i<totalSlots;i++){
    const slotUnits = units - i*2;
    const cls = slotUnits >= 2 ? "cell full" : slotUnits === 1 ? "cell half" : "cell";
    html += `<div class="${cls}"></div>`;
  }
  html += `</div>`;
  return html;
}

/* Views */
function startView(){
  const hearts = totalHearts();
  const nextGiftInUnits = UNITS_PER_GIFT - (state.bank.totalUnits % UNITS_PER_GIFT || UNITS_PER_GIFT);
  const nextGiftInHearts = nextGiftInUnits / 2;

  const surpriseBtn = canUseSurprise()
    ? `<button class="btn purple big" onclick="useSurprise()">T√§gliche √úberraschung ‚ú®</button>
       <div class="muted" style="margin-top:8px">Einmal am Tag. Vor oder nach der Arbeit.</div>`
    : `<button class="btn ghost big" disabled style="opacity:.55;cursor:not-allowed">√úberraschung schon genutzt ‚úÖ</button>
       <div class="muted" style="margin-top:8px">Morgen gibt‚Äôs die n√§chste.</div>`;

  return `
    <div class="hero">
      <img src="./snuggy_voll.png" alt="Snuggy" onerror="this.onerror=null;this.src='./snuggy_avatar_v3.png'">
      <div class="heroBottom">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="pill">Konto: <span style="font-size:14px">‚ô• ${unitsToHeartsText(state.bank.totalUnits)}</span></div>
          <div class="pill">N√§chstes Geschenk in: <span style="font-size:14px">‚ô• ${unitsToHeartsText(nextGiftInUnits)}</span></div>
        </div>

        <div style="height:12px"></div>
        <button class="btn primary big" onclick="go('kats')">Jetzt spielen</button>

        <div style="height:10px"></div>
        <div class="muted">iPhone: Safari ‚Üí Teilen ‚Üí ‚ÄûZum Home-Bildschirm‚Äú ‚Üí als App starten.</div>

        <div style="height:14px"></div>
        ${surpriseBtn}
      </div>
    </div>
  `;
}

function categoriesView(){
  return `
    <div class="card">
      <h2 style="margin:0 0 8px;font-size:16px;font-weight:1000">Kategorien</h2>
      <div class="muted">Tippe eine Kategorie ‚Üí dann siehst du die Rubriken (gro√üe Buttons).</div>
    </div>

    <div style="height:12px"></div>

    <div class="catGrid">
      ${state.cats.map(c=>`
        <button class="btn big ${c.color}" onclick="openCat('${c.id}')">${c.name}</button>
      `).join("")}
    </div>
  `;
}

function catView(){
  const catId = state.activeCat;
  const cat = state.cats.find(c=>c.id===catId);
  const items = state.quests.filter(q=>q.cat===catId);

  return `
    <div class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:1000;font-size:16px">${cat?.name || "Kategorie"}</div>
          <div class="muted">Rubriken: gro√ü. Herzen: klein & kompakt.</div>
        </div>
        <button class="btn" onclick="go('kats')">‚Ü©Ô∏é</button>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="col">
      ${items.map(q=>{
        const maxMini = 10;
        const heartsText = unitsToHeartsText(q.progressUnits);
        return `
          <button class="btn rubricBtn big" onclick="openQuest('${q.id}')">
            <div style="min-width:0">
              <div class="rubricTitle">${q.title}</div>
              <div class="rubricStep">${q.step}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <div class="badge">‚ô• ${heartsText}</div>
              ${miniHearts(q.progressUnits, maxMini)}
            </div>
          </button>
        `;
      }).join("")}
    </div>
  `;
}

function questView(){
  const q = state.quests.find(x=>x.id===state.activeQuestId);
  if(!q) return `<div class="card">Quest nicht gefunden.</div>`;

  const cat = state.cats.find(c=>c.id===q.cat);
  const heartsText = unitsToHeartsText(q.progressUnits);
  const totalText = unitsToHeartsText(state.bank.totalUnits);

  // Buttons: Mini alle 2 Klicks 1 Herz (0.5 je Klick), Normal 1 Herz, Boss 2 Herzen
  const miniLabel = q.doublePoints ? "Mini +1‚ô• (doppelt!)" : "Mini +0,5‚ô•";
  const normalLabel = q.doublePoints ? "Normal +2‚ô• (doppelt!)" : "Normal +1‚ô•";
  const bossLabel = q.doublePoints ? "Boss +4‚ô• (doppelt!)" : "Boss +2‚ô•";

  const miniUnits = q.doublePoints ? (U_HALF*2) : U_HALF;     // 1 oder 2
  const normalUnits = q.doublePoints ? (U_HEART*2) : U_HEART; // 2 oder 4
  const bossUnits = q.doublePoints ? (U_BOSS*2) : U_BOSS;     // 4 oder 8

  return `
    <div class="card">
      <div class="questTop">
        <img class="avatar" src="./snuggy_avatar_v3.png" alt="Snuggy">
        <div style="min-width:0">
          <p class="qTitle">${q.title}</p>
          <p class="qSub">${cat?.name || ""} ¬∑ ${q.step}</p>
        </div>
      </div>

      <div class="sep"></div>

      <div class="scoreRow">
        <div class="pill">Rubrik: ‚ô• ${heartsText}</div>
        <div class="pill">Konto: ‚ô• ${totalText}</div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button class="btn green" onclick="addAction('${q.id}', ${miniUnits}, 'mini')">${miniLabel}</button>
        <button class="btn primary" onclick="addAction('${q.id}', ${normalUnits}, 'normal')">${normalLabel}</button>
        <button class="btn purple" onclick="addAction('${q.id}', ${bossUnits}, 'boss')">${bossLabel}</button>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <button class="btn ghost" onclick="undoAction('${q.id}')">‚Ü©Ô∏é Undo</button>
        <button class="btn ghost" onclick="resetQuest('${q.id}')">Rubrik leeren</button>
        <button class="btn" onclick="openCat('${q.cat}')">‚Ü©Ô∏é Rubriken</button>
      </div>

      <div class="sep"></div>

      <div class="muted"><b>Herz-Raster</b> (Mini f√ºllt halb, Normal voll, Boss 2 Herzen)</div>
      ${questGrid(q.progressUnits, q.gridHearts)}
    </div>
  `;
}

function kontoView(){
  const hearts = totalHearts();
  const nextGiftInUnits = UNITS_PER_GIFT - (state.bank.totalUnits % UNITS_PER_GIFT || UNITS_PER_GIFT);

  const bigGoalUnits = (Number(state.bank.bigGoalHearts || 100) * 2);
  const toBig = bigGoalUnits - (state.bank.totalUnits % bigGoalUnits || bigGoalUnits);

  const hist = (state.bank.giftHistory || []).slice(-6).reverse();

  return `
    <div class="card">
      <div style="font-weight:1000;font-size:16px;margin-bottom:6px">Mach-gut-Konto</div>
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="pill">‚ô• ${unitsToHeartsText(state.bank.totalUnits)}</div>
        <button class="btn" onclick="openGift()">Geschenk testen üéÅ</button>
      </div>

      <div style="height:10px"></div>
      <div class="muted">
        Geschenk alle <b>5 Herzen</b> ¬∑ n√§chstes in <b>‚ô• ${unitsToHeartsText(nextGiftInUnits)}</b><br>
        Boss-Ziel: <b>${state.bank.bigGoalText}</b> (bei ‚ô• ${state.bank.bigGoalHearts}) ¬∑ noch <b>‚ô• ${unitsToHeartsText(toBig)}</b>
      </div>

      <div class="sep"></div>

      <div style="font-weight:1000;margin-bottom:6px">Geschenke (Zufall, alle 5 Herzen)</div>
      <div class="muted">Diese Liste kannst du sp√§ter easy erweitern.</div>
      <div class="sep"></div>
      ${(state.bank.gifts||[]).map(t=>`<div class="card soft" style="padding:10px;margin:8px 0">${t}</div>`).join("")}

      <div class="sep"></div>
      <div style="font-weight:1000;margin-bottom:6px">Letzte Geschenke</div>
      ${hist.length ? hist.map(h=>`
        <div class="card soft" style="padding:10px;margin:8px 0">
          <div style="font-weight:950">${h.text}</div>
          <div class="muted" style="margin-top:4px">${new Date(h.t).toLocaleDateString()}</div>
        </div>
      `).join("") : `<div class="muted">Noch keine. Kommt automatisch.</div>`}
    </div>
  `;
}

function settingsView(){
  const low = !!state.settings.lowMotion;
  return `
    <div class="card">
      <div style="font-weight:1000;font-size:16px;margin-bottom:6px">Einstellungen</div>

      <div class="sep"></div>

      <div class="row" style="align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:950">Wenig Animation</div>
          <div class="muted">Mehr Ruhe, weniger Reiz.</div>
        </div>
        <input type="checkbox" ${low ? "checked":""}
          onchange="state.settings.lowMotion=this.checked; saveState(); render();" />
      </div>

      <div class="sep"></div>

      <button class="btn purple big" onclick="resetAll()">Alles zur√ºcksetzen</button>
      <div class="muted" style="margin-top:8px">Nur wenn wirklich neu starten.</div>
    </div>
  `;
}

function resetAll(){
  if(!confirm("Wirklich alles l√∂schen?")) return;
  state = structuredClone(DEFAULT);
  saveState();
  render();
}

/* Render */
function render(){
  document.documentElement.style.scrollBehavior = state.settings.lowMotion ? "auto" : "smooth";
  const app = document.getElementById("app");

  if(state.view === "start") app.innerHTML = startView();
  else if(state.view === "kats") app.innerHTML = categoriesView();
  else if(state.view === "cat") app.innerHTML = catView();
  else if(state.view === "quest") app.innerHTML = questView();
  else if(state.view === "konto") app.innerHTML = kontoView();
  else if(state.view === "settings") app.innerHTML = settingsView();
  else app.innerHTML = startView();
}

/* Service Worker (offline-first) */
if("serviceWorker" in navigator){
  window.addEventListener("load", async ()=>{
    try{ await navigator.serviceWorker.register("./sw.js"); }catch(e){}
  });
}

render();
</script>
</body>
</html>
